# Quickstart: Pre-Record Loop Element

## Build
The project uses Conan for dependency resolution and CMake presets generated by Conan. Follow the same steps described in the repository `README.md` ("Building the Code"), summarized here.

### 1. Install Dependencies
- Ensure GStreamer and GLib are installed (Homebrew on macOS):
  - `brew install gstreamer gst-plugins-base gst-plugins-good gst-plugins-bad glib`
- Ensure Conan is installed (`pip install conan` or Homebrew).

### 2. Conan Install (Fresh Build)
Debug:
```
conan install . --build=missing --settings=build_type=Debug
```
Release:
```
conan install . --build=missing
```

### 3. Configure via Preset
Debug:
```
cmake --preset=conan-debug
```
Release:
```
cmake --preset=conan-release
```

### 4. Build
Debug:
```
cmake --build --preset=conan-debug
```
Release:
```
cmake --build --preset=conan-release
```

### 5. Set GST_PLUGIN_PATH
Locate the built module (Debug example):
```
export GST_PLUGIN_PATH="$(pwd)/build/Debug/gstprerecordloop:$GST_PLUGIN_PATH"
```
(Adjust path for Release: `build/Release/gstprerecordloop`). Ensure the directory contains `libgstprerecordloop.*` (platform-specific extension: `.so`, `.dylib`, or `.dll`).

### 6. Verify Registration
```
gst-inspect-1.0 prerecloop || gst-inspect-1.0 pre_record_loop
```
If not found, confirm `GST_PLUGIN_PATH` and rebuild.

## Basic Pipeline
```
gst-launch-1.0 videotestsrc is-live=true num-buffers=300 ! x264enc key-int-max=30 tune=zerolatency ! h264parse ! pre_record_loop name=pr ! fakesink
```

## Trigger Flush
Python (PyGObject) example:
```python
import gi, time
gi.require_version('Gst', '1.0')
from gi.repository import Gst
Gst.init(None)
# assume pipeline created with element named 'pr'
s = Gst.Structure.new_empty('prerecord-flush')
ev = Gst.Event.new_custom(Gst.EventType.CUSTOM_DOWNSTREAM, s)
pr = pipeline.get_by_name('pr')
pr.send_event(ev)
```

## Re-Arm Buffering
```python
s = Gst.Structure.new_empty('prerecord-arm')
ev = Gst.Event.new_custom(Gst.EventType.CUSTOM_DOWNSTREAM, s)
pr.send_event(ev)
```

## Properties
| Property | Type | Default | Description |
|----------|------|---------|-------------|
| max-time | guint (s) | 10 | Max buffered duration (adaptive 2-GOP floor) |
| flush-on-eos | enum { auto, always, never } | auto | EOS buffer flush policy |
| silent | gboolean | FALSE | Suppress info-level logging |

## Behavior Notes
- Flush ignores concurrent triggers.
- Re-arm only valid after a flush (PASS_THROUGH mode).
- Oversized GOP retained; time cap enforced after >=2 GOPs.
- Sub-second max-time values floored.
- AUTO flush-on-eos: flush only if already PASS_THROUGH.

## Testing Hints
- Use `GST_DEBUG=*:3,pre_record_loop:6` (or `prerecloop` if that's the registered name) for detailed logs.
- Validate re-arm path by issuing flush → arm → flush sequence.
- For EOS tests use `-e` with `gst-launch-1.0` and `num-buffers` on source.

## Troubleshooting
| Issue | Check |
|-------|-------|
| Element not found | `echo $GST_PLUGIN_PATH`, run `gst-inspect-1.0` again |
| Wrong caps negotiation | Ensure `h264parse` before element; confirm encoder outputs H.264 |
| No flush effect | Confirm custom event structure name `prerecord-flush` and that buffers were accumulated |
| Re-arm ignored | Element may still be draining or already in BUFFERING |
